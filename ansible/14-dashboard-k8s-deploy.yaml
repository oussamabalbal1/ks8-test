---
- name: Deploy Kubernetes Dashboard with Basic Authentication
  hosts: localhost
  become: true
  tasks:
    - name: Download Kubernetes Dashboard manifest
      ansible.builtin.get_url:
        url: https://raw.githubusercontent.com/kubernetes/dashboard/v2.7.0/aio/deploy/recommended.yaml
        dest: /tmp/kubernetes-dashboard.yaml

    - name: Apply the Kubernetes Dashboard manifest
      ansible.builtin.command:
        cmd: kubectl apply -f /tmp/kubernetes-dashboard.yaml
      register: dashboard_deployment

    - name: Ensure Dashboard is deployed
      ansible.builtin.debug:
        msg: "{{ dashboard_deployment.stdout }}"

    - name: Create ConfigMap for username and password
      ansible.builtin.command:
        cmd: |
          kubectl create configmap dashboard-auth --from-literal=username=oussama --from-literal=password=oussama -n kubernetes-dashboard --dry-run=client -o yaml | kubectl apply -f -

    - name: Patch Kubernetes Dashboard to use ConfigMap for authentication
      ansible.builtin.command:
        cmd: |
          kubectl patch deployment kubernetes-dashboard -n kubernetes-dashboard \
          --patch '{"spec":{"template":{"spec":{"containers":[{"name":"kubernetes-dashboard","env":[{"name":"DASHBOARD_USERNAME","valueFrom":{"configMapKeyRef":{"name":"dashboard-auth","key":"username"}}},{"name":"DASHBOARD_PASSWORD","valueFrom":{"configMapKeyRef":{"name":"dashboard-auth","key":"password"}}}]}]}}}}'

    - name: Expose the Kubernetes Dashboard service
      ansible.builtin.command:
        cmd: kubectl expose deployment kubernetes-dashboard --type=NodePort --name=kubernetes-dashboard-nodeport -n kubernetes-dashboard

    - name: Display the access instructions
      ansible.builtin.debug:
        msg: "Access the dashboard using NodePort. Run `kubectl get svc -n kubernetes-dashboard` to see the exposed port."
